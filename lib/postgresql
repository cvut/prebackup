#!/usr/local/bin/prebackup
# vim: set ft=sh ts=4:
#
# Variables:
#   exclude_dbs : An array of database names to exclude from backup (optional).

setup() {
	if [ -n "$exclude_dbs" ] && ! is-array exclude_dbs; then
		fail 'Variable $exclude_dbs must be an array!'
	fi
	exclude_dbs+=( 'template0' )
}

pre-backup() {
	local dbname
	local dbs_list_sql='SELECT datname FROM pg_database ORDER BY datname;'
	local psql_opts='--no-psqlrc --no-align --tuples-only'

	info 'Dumping global objects'
	pg_dumpall --globals-only | gzip > "$target_dir/globals.sql.gz"

	psql $psql_opts --command="$dbs_list_sql" | while read -r dbname; do

		if is-member "$dbname" "${exclude_dbs[@]}"; then
			info "Skipping database $dbname"
		else
			info "Dumping database $dbname"
			pg_dump --dbname="$dbname" --format=c --file="${target_dir}/${dbname}.dump"
		fi
	done
}

post-backup() {
	if [ ! -d "$target_dir" ]; then
		fail "$target_dir does not exist or not a directory!"
	fi
	rm -Rf "$target_dir"/globals.sql.gz
	rm -Rf "$target_dir"/*.dump
}
